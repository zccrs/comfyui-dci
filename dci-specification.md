# DCI 图标文件规范

> **警告！此规范内容是不稳定版本，可能会发生破坏兼容性的更新。当无法保障向下兼容时，将会升级此文档的主版本号，如从"1.0"更新到"2.0"。反之，普通更新只会升级次版本号，如"1.0"更新到"1.1"，其对"1.0"版本向下兼容。请在使用前确认此文档的版本号，并为将来可能发生的兼容性变化做好准备。**

- **维护者**：zccrs zhangjide@uniontech.com
- **版本**：1.1
- **修改日期**：2022.11.21
- **议题**：#5
- **原文档**：[Desktop Spec Group - 图标文件规范](https://desktopspec.org/unstable/%E5%9B%BE%E6%A0%87%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83.html)

## 引言

本规范约定了各类图标文件的内部数据格式要求，以及此类文件的使用规范。

## 归档打包

dci 文件（以下简称为 dci）为一种归档打包格式，其规定了如何将多个图标文件合并为一个文件。

### 格式

- **格式名称**：`dci`，为 DSG combined icons 的缩写
- **mimetype**：image/dci，继承自：application/octet-stream
- **magic**：DCI，类型为 string，offset 为 0
- **此类型对应的图标名**：image-dci
- **后缀名**：dci

对应的 mimetype 描述文件内容：关于 mimetype 规范的详细设计请查看 http://www.freedesktop.org/standards/shared-mime-info

```xml
<?xml version="1.0" encoding="UTF-8"?>
<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
   <mime-type type="image/dci">
      <comment>DSG Icon file format</comment>
      <comment xml:lang="zh_CN">深度图标文件格式</comment>
      <glob pattern="*.dci"/>
      <icon name="image-dci"/>
      <magic priority="80">
        <match value="DCI" type="string" offset="0"/>
      </magic>
   </mime-type>
</mime-info>
```

### 文件头

dci 使用小端序，文件的元数据位于文件开头。内容如下：

| 起始地址:结束地址 | 名称 | 大小 | 缺省值 |
|----------------|------|------|--------|
| 0x0000:0x0003 | magic | 4B | DCI |
| 0x0004:0x0004 | 版本 | 1B | - |
| 0x0005:0x0007 | 文件数量 | 3B | - |
| 0x0008:0x0057 | 文件1元数据 | 72B | [格式](#文件的元数据) |
| ... | 文件元数据 | - | [格式](#文件的元数据) |

> 这里的文件数量指根文件，不包含目录内的子文件。

> 文件顺序需按照其名称升序排列，此排列不区分文件类型。另外，需遵循自然排序（如"a2"在"a11"之前）规则。

### 文件的元数据

| 相对起始地址:相对结束地址 | 名称 | 大小 | 缺省值 |
|------------------------|------|------|--------|
| 0x0000:0x0000 | 文件类型 | 1B | [可选值](#文件类型) |
| 0x0001:0x003F | 文件名 | 63B | - |
| 0x0040:0x0048 | 内容的大小 | 8B | - |
| 0x0049:0x???? | 内容 | - | - |

> 文件名为 UTF-8 编码，必须以 '\0' 结尾，且不可包含 '/' 字符。
>
> 目录的内容是：此目标内子目录以及文件的元数据和数据。

#### 文件类型

| 值 | 类型 |
|----|------|
| 0 | 保留 |
| 1 | 文件 |
| 2 | 目录 |
| 3 | 链接 |

> 目录文件也属于文件类型的一种，可在目录下嵌套子目录。

> 目录内的文件顺序需按照其名称升序排列，此排列不区分文件类型。另外，需遵循英文环境（无国家要求）下的自然排序（如"a2"在"a11"之前）规则。

### 链接文件

链接的目标可以是"文件"或其它（不可链接自身）"链接"，否则认为此链接目标无效。创建链接时不检查链接的目标是否存在，对链接文件内容的读写操作等价于读写链接的目标，如若链接目标无效或不存在，则读写失败。获取链接的目标路径时，如果链接文件无效，需给出一个空路径。此外，需要提供方法以允许获取链接路径的原始数据。

链接文件的内容格式：

| 相对起始地址:相对结束地址 | 名称 | 大小 | 缺省值 |
|------------------------|------|------|--------|
| 0x0000:0x???? | 目标路径 | 取决于元数据中指定的内容大小 | - |

> 内容编码为 UTF-8，路径需符合 UNIX 标准，可使用相对路径。相对路径的 "." 和 ".." 仅可用于路径的开头，当"."、".."出现在路径中间时，如 "/./test.txt"、"../a/../"，此处的"."和".."需当作文件名称处理。

## 图标文件规范

在归档打包中描述了 dci 文件的归档规范，本章节将描述 dci 格式的文件目录结构和命名规范。

### 图标状态

图标适应环境变化时所需要展现的不同形态，分为以下四种状态：

- **normal**：缺省状态
- **disabled**：被禁用时的状态，一般表现为不再响应鼠标、键盘等输入事件
- **hover**：鼠标悬浮在图标上的状态
- **pressed**：点击后且未释放时的状态

> 当图标只提供 `normal` 状态的文件时，可使用一些固定规则对 `normal` 状态进行加工而得到其它状态，此规范不约束加工后的效果。

### 图标动画

如果对应状态的图片文件具有动画效果，如嵌入了动态的 webp 图片，则应当在图标状态变化时播放动画。动画播放需满足以下规则：

1. 初始化状态不自动播放动画，初始为 normal 状态时显示动画第一帧，其它状态显示动画的最后一帧；
2. normal 状态动态图的第一帧和最后一帧要等价，即内容完全相同；
3. 当从 normal 状态变为 hover 状态时，使用 1.0 倍速正序播放 hover 图片的动画，且停留到最后一帧；
4. 当从 hover 状态变为 pressed 状态时，使用 1.0 倍速正序播放 pressed 图片的动画，且停留到最后一帧；
5. 当从 normal 状态变为 pressed 状态时，如果存在 hover 状态，则界面效果（仅影响UI，不实际改变图标的当前状态）先变化为 hover 状态，再由 hover 状态变化为 pressed 状态，在此期间的动画使用 2.0（如果 hover 状态是静态图片，则使用 1.0 倍速）倍速正序播放，不同动画图片切换时中间无停顿。否则，如果 hover 状态不存在，则直接使用 1.0 倍速正序播放 pressed 图片的动画。动画播放完毕后停留到最后一帧；
6. 当从 hover 状态变为 normal 状态时，使用 1.0 倍速倒序播放 hover 图片动画，不停留到最后一帧，动画播放完毕后当作初始化状态停留到 normal 状态的图片；
7. 当从 pressed 状态变为 hover 状态时，使用 1.0 倍速倒序播放 pressed 图片动画，不停留到最后一帧，动画播放完毕后当作初始化状态停留到 hover 状态的图片；
8. 当从 pressed 状态变为 normal 状态时，如果存在 hover 状态，则界面效果（仅影响UI，不实际改变图标的当前状态）先变化为 hover 状态，再由 hover 状态变化为 normal，在此期间的动画使用 2.0（如果 hover 状态是静态图片，则使用 1.0 倍速）倍速倒序播放，不同动画图片切换时中间无停顿。否则，如果 hover 状态不存在，则直接使用 1.0 倍速倒序播放 pressed 图片动画，不停留到最后一帧，动画播放完毕后当作初始化状态停留到 normal 状态的图片；

### 目录结构

dci 文件内部的目录结构遵循以下规范：

```
<图标大小>/<图标状态>.<色调类型>/<缩放倍数>/<图层文件>
```

#### 目录层级说明

1. **一级目录**：图标大小（如：16、24、32、48、64、128、256）
2. **二级目录**：图标状态.色调类型（如：normal.light、hover.dark）
3. **三级目录**：缩放倍数（如：1、2、3、1.5、2.5）
4. **四级文件**：图层文件（图片文件）

#### 示例目录结构

```
256/
├── normal.light/
│   ├── 1/
│   │   ├── 1.0p.-1.0_0_0_0_0_0_0.webp
│   │   └── 2.5p.1.10_20_30_-10_15_-5_25.png
│   └── 2/
│       └── 1.0p.-1.0_0_0_0_0_0_0.webp
├── hover.light/
│   └── 1/
│       └── 1.0p.-1.0_0_0_0_0_0_0.webp
└── pressed.light/
    └── 1/
        └── 1.0p.-1.0_0_0_0_0_0_0.webp
```

### 图层文件命名规范（重点优化）

图层文件名是DCI规范中最复杂的部分，包含了图层的所有属性信息。

#### 文件名格式

```
<优先级>.<外边框>p.<调色板>.<颜色调整参数>.<格式>
```

其中颜色调整参数使用下划线分隔：

```
<色调>_<饱和度>_<亮度>_<红>_<绿>_<蓝>_<透明度>
```

#### 完整格式示例

```
优先级.外边框p.调色板.色调_饱和度_亮度_红_绿_蓝_透明度.格式
```

#### 参数详细说明

| 参数 | 类型 | 范围/可选值 | 说明 |
|------|------|-------------|------|
| **优先级** | 整数 | 1-n | 图层绘制顺序，数值越大越靠上层 |
| **外边框** | 整数+p | 0-100 | 外边框值，必须加"p"后缀，如"5p" |
| **调色板** | 整数 | -1, 0, 1, 2, 3 | -1=无, 0=前景色, 1=背景色, 2=高亮前景色, 3=高亮色 |
| **色调** | 整数 | -100~100 | 色调调整百分比 |
| **饱和度** | 整数 | -100~100 | 饱和度调整百分比 |
| **亮度** | 整数 | -100~100 | 亮度调整百分比 |
| **红** | 整数 | -100~100 | 红色分量调整百分比 |
| **绿** | 整数 | -100~100 | 绿色分量调整百分比 |
| **蓝** | 整数 | -100~100 | 蓝色分量调整百分比 |
| **透明度** | 整数 | -100~100 | 透明度调整百分比 |
| **格式** | 字符串 | png, jpg, webp, png.alpha8, webp.alpha8 | 图片格式后缀，alpha8是特殊状态标识 |

#### 文件名示例

```bash
# 基础图层（优先级1，无外边框，无调色板，无颜色调整）
1.0p.-1.0_0_0_0_0_0_0.webp

# 高优先级图层（优先级2，外边框5像素，前景色调色板，有颜色调整）
2.5p.0.10_20_30_-10_15_-5_25.png

# 背景图层（优先级1，无外边框，背景色调色板，仅亮度调整）
1.0p.1.0_0_50_0_0_0_0.webp

# Alpha8格式图层（用于调色板优化）
3.2p.2.0_0_0_0_0_0_0.webp.alpha8
```

#### 颜色调整算法

颜色调整参数的计算方式：

- **正值调整**：`新值 = 原值 + (255 - 原值) × 调整百分比`
- **负值调整**：`新值 = 原值 × (1 + 调整百分比)`
- **特殊情况**：
  - RGB调整参数为-100时，颜色为黑色
  - RGB调整参数为100时，颜色为白色

#### Alpha8格式说明

Alpha8格式是DCI规范中的一个重要优化特性，专门用于调色板图标的存储优化。

**核心原理**：
- Alpha8格式是一个仅包含alpha通道的单通道图片，没有RGB通道
- 由于webp、png等标准格式不支持alpha单通道格式，只支持灰度单通道格式
- 因此借用QImage::Format_Grayscale8格式存储，将图片的alpha通道强制当作灰度数据使用
- 文件后缀使用`.原格式.alpha8`（如`.webp.alpha8`、`.png.alpha8`）作为特殊标识

**使用场景**：
- 适用于使用调色板的图层，这些图层在渲染时会被动态着色
- 由于渲染时会根据调色板获取颜色并对图片进行着色，RGB通道成为冗余数据
- 去除RGB通道可以显著减小文件大小，避免存储浪费

**存储机制**（参考 [dci-image-converter工具](https://github.com/linuxdeepin/dtkgui/blob/master/tools/dci-image-converter/main.cpp)）：
```cpp
// 存储时：将alpha通道作为灰度数据保存
QImage alphaImage = originalImage.convertToFormat(QImage::Format_Grayscale8);
// 实际保存的是alpha通道数据，但以灰度格式存储
```

**读取机制**（参考 [ddciicon.cpp实现](https://github.com/linuxdeepin/dtkgui/blob/master/src/util/ddciicon.cpp#L224)）：
```cpp
// 读取时：识别.alpha8后缀，做反向操作
if (filename.endsWith(".alpha8")) {
    QImage grayscaleImage = loadImage(imageData);
    // 将灰度数据还原为alpha通道
    QImage alphaImage = convertGrayscaleToAlpha(grayscaleImage);
    // 根据调色板和颜色调整参数进行着色
    applyPaletteColor(alphaImage, paletteColor, colorAdjustments);
}
```

**技术优势**：
- **存储效率**：单通道存储，文件大小约为RGBA格式的1/4
- **渲染灵活性**：支持动态主题切换，同一图片可应用不同调色板
- **质量保持**：alpha通道信息完整保留，着色后质量无损失
- **兼容性**：基于标准图片格式，工具链兼容性好

### 目录/文件名变量可选值

| 变量 | 可选值 | 备注 |
|------|--------|------|
| **图标大小** | 整数 | 优先查找大于等于目标大小的图标，无法找到时使用最大的图标资源 |
| **图标状态** | normal, disabled, hover, pressed | normal状态的light图标必须存在，其它状态可选 |
| **色调类型** | light, dark | 查找图标时色调类型必须完全匹配 |
| **缩放倍数** | 1, 2, 3, 1.5, 2.5等 | 至少要提供1、2、3三类缩放比例 |
| **图层优先级** | 1-n | 优先级代表图层的绘制顺序，从1-n进行绘制 |
| **外边框** | 0-100 | 外边框在有阴影效果的图标中充分利用，必须加"p"后缀 |
| **调色板** | -1, 0, 1, 2, 3 | 无调色板(-1)、前景色(0)、背景色(1)、高亮前景色(2)、高亮色(3) |
| **颜色调整** | -100~100 | 用于调节图片填充颜色的各项参数百分比 |
| **图片格式** | png, jpg, webp, png.alpha8, webp.alpha8 | 支持alpha8状态标识用于调色板优化 |

### 查找规则

1. **大小匹配**：优先查找大于等于目标大小的图标，无法找到时使用最大的图标资源
2. **状态回退**：如果对应状态不存在，允许使用normal.light状态代替
3. **色调匹配**：色调类型必须完全匹配
4. **缩放选择**：如目标缩放倍数不存在，选用更高倍数的图，无更高倍数时使用低倍数中较高的图片

### 实际应用示例

以下是一个完整的DCI文件内部结构示例：

```
dci-icon-example/
├── 16/
│   └── normal.light/
│       └── 1/
│           └── 1.0p.-1.0_0_0_0_0_0_0.png
├── 24/
│   ├── normal.light/
│   │   ├── 1/
│   │   │   ├── 1.0p.-1.0_0_0_0_0_0_0.webp
│   │   │   └── 2.3p.1.0_0_20_0_0_0_0.webp
│   │   └── 2/
│   │       └── 1.0p.-1.0_0_0_0_0_0_0.webp
│   └── hover.light/
│       └── 1/
│           └── 1.0p.-1.0_0_10_0_0_0_0_0.webp
└── 32/
    ├── normal.light/
    │   └── 1/
    │       ├── 1.0p.-1.0_0_0_0_0_0_0_0.webp
    │       ├── 2.5p.0.10_20_30_0_0_0_0.png
    │       └── 3.0p.2.0_0_0_50_-20_10_0.webp.alpha8
    ├── hover.light/
    │   └── 1/
    │       └── 1.0p.-1.0_5_15_0_0_0_0_0.webp
    └── pressed.light/
        └── 1/
            └── 1.0p.-1.-5_-10_-5_0_0_0_0.webp
```

## 总结

DCI格式是一个功能强大的图标打包格式，支持：

1. **多状态图标**：normal、disabled、hover、pressed
2. **多色调支持**：light、dark
3. **多缩放比例**：1x、2x、3x等
4. **图层系统**：支持多图层合成，每层可独立设置属性
5. **调色板系统**：支持主题色彩适配
6. **颜色调整**：精确的颜色控制
7. **格式优化**：支持alpha8状态标识减小文件大小

通过合理使用这些特性，可以创建适应各种显示环境和主题的高质量图标资源。
